# Robot Vision Controller with AI Navigation & Nav2 Integration

Há»‡ thá»‘ng Ä‘iá»u khiá»ƒn robot TurtleBot3 tá»± Ä‘á»™ng vá»›i AI Agent thÃ´ng minh, tÃ­ch há»£p **Nav2 navigation stack** cho path planning an toÃ n. Robot cÃ³ thá»ƒ hiá»ƒu vÃ  thá»±c hiá»‡n nhiá»‡m vá»¥ phá»©c táº¡p tá»« natural language prompts nhÆ° Ä‘áº¿m váº­t thá»ƒ, bÃ¡m theo má»¥c tiÃªu di Ä‘á»™ng, tuáº§n tra vÃ²ng trÃ²n, vÃ  nhiá»u hÆ¡n ná»¯a.

## ğŸ¤– AI Models Used

|         Model           |                     Purpose                        |        When Used        | Critical |
|-------------------------|----------------------------------------------------|-------------------------|----------|
| **LLM (Llama 3.1 70B)** | Parse natural language prompt â†’ structured mission |       1x at startup     |  âœ… Yes  |
|    **YOLO (v11n)**      |            Object detection & tracking             | Continuous (2Hz cached) |  âœ… Yes  |

**Performance:**
- ğŸš€ Real-time navigation: <100ms per iteration
- ğŸ’¾ Memory usage: ~0.5GB (YOLO only)
- âš¡ Startup time: ~1 second

---

## ğŸ“‹ Má»¥c lá»¥c
- [Cáº¥u trÃºc thÆ° má»¥c](#cáº¥u-trÃºc-thÆ°-má»¥c)
- [Tá»•ng quan há»‡ thá»‘ng](#tá»•ng-quan-há»‡-thá»‘ng)
- [Kiáº¿n trÃºc](#kiáº¿n-trÃºc)
- [Nav2 Integration](#nav2-integration)
- [Mission Types](#mission-types)
- [YÃªu cáº§u há»‡ thá»‘ng](#yÃªu-cáº§u-há»‡-thá»‘ng)
- [CÃ i Ä‘áº·t](#cÃ i-Ä‘áº·t)
- [CÃ¡ch cháº¡y](#cÃ¡ch-cháº¡y)
- [Ghi chÃº quan trá»ng](#ghi-chÃº-quan-trá»ng)

## ğŸ“ Cáº¥u trÃºc thÆ° má»¥c

```
multi_function_agent/
    â”œâ”€â”€ configs/
    â”‚   â””â”€â”€ config.yml                            # Cáº¥u hÃ¬nh system + Nav2
    â””â”€â”€ robot_vision_controller/
        â”œâ”€â”€ main.py                               # Entry point - HYBRID LOOP
        â”œâ”€â”€ core/
        â”‚   â”œâ”€â”€ query_extractor.py                # Prompt information extraction
        â”‚   â”œâ”€â”€ goal_parser.py                    # LLM mission parser 
        â”‚   â”œâ”€â”€ mission_controller.py             # Mission state machine 
        â”‚   â””â”€â”€ models.py                         # YOLO model management
        â”œâ”€â”€ navigation/
        â”‚   â”œâ”€â”€ nav2_interface.py                 # Nav2 Python interface
        â”‚   â”œâ”€â”€ navigation_reasoner.py            # Mission-aware manual control
        â”‚   â””â”€â”€ robot_controller_interface.py     # ROS/Gazebo interface + Nav2
        â”œâ”€â”€ perception/
        â”‚   â”œâ”€â”€ lidar_monitor.py                  # Real-time collision avoidance
        â”‚   â”œâ”€â”€ robot_vision_analyzer.py          # YOLO + LIDAR spatial analysis
        â”‚   â”œâ”€â”€ spatial_detector.py               # LIDAR spatial analysis
        â”‚   â””â”€â”€ rtsp_stream_handler.py            # RTSP stream handler        
        â””â”€â”€ utils/
            â”œâ”€â”€ geometry_utils.py                 # Geometry calculation
            â”œâ”€â”€ movement_commands.py              # Commands to move
            â”œâ”€â”€ safety_checks.py                  # Safety First
            â”œâ”€â”€ ros_interface.py                  # ROS utilities
            â””â”€â”€ log/
                â”œâ”€â”€ error_handlers.py             # Error logging
                â”œâ”€â”€ output_formatter.py           # Output logging
                â””â”€â”€ performance_logger.py         # Performance logging

docker/   
    â”œâ”€â”€ docker-compose.yml                        # Multi-container orchestration
    â”œâ”€â”€ Dockerfile.ros2                           # ROS2 + Nav2 + Gazebo container
    â”œâ”€â”€ Dockerfile.nat                            # NAT + AI Agent container
    â”œâ”€â”€ run.sh                                    # Main launcher script
    â”œâ”€â”€ stop.sh                                   # Graceful shutdown
    â”œâ”€â”€ status.sh                                 # Health monitoring
    â”œâ”€â”€ Makefile                                  # Convenience commands
    â””â”€â”€ scripts/
        â””â”€â”€ ros2_entrypoint.sh                    # ROS2 service startup

ros2_bridge_service/
â””â”€â”€ robot_bridge_server.py                        # HTTP â†” ROS2 bridge

turtlebot3_ws/
â””â”€â”€ src/
    â””â”€â”€ custom_controller/
        â””â”€â”€ custom_controller/
            â””â”€â”€ rtsp_publisher.py                 # RTSP stream publisher
```

---

## ğŸ¯ Tá»•ng quan há»‡ thá»‘ng

Há»‡ thá»‘ng Ä‘Æ°á»£c thiáº¿t káº¿ theo **kiáº¿n trÃºc Docker Multi-Container**, tÃ¡ch biá»‡t hoÃ n toÃ n giá»¯a AI Agent vÃ  ROS2 stack, Ä‘á»“ng thá»i cho phÃ©p giao tiáº¿p real-time qua ROS2 DDS network.

### **ThÃ nh pháº§n chÃ­nh:**

#### **1. ROS2-Nav2 Container** (Python 3.10)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ROS2 Humble + Nav2 + Gazebo Container     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ TurtleBot3 Simulation (Gazebo)           â”‚
â”‚  â€¢ Nav2 Navigation Stack                    â”‚
â”‚    - Global Planner (Dijkstra/A*)           â”‚
â”‚    - Local Planner (DWA)                    â”‚
â”‚    - Costmap (Obstacle inflation)           â”‚
â”‚    - Recovery Behaviors                     â”‚
â”‚  â€¢ SLAM Toolbox (Real-time mapping)         â”‚
â”‚  â€¢ MediaMTX (RTSP streaming)                â”‚
â”‚  â€¢ Bridge Server (HTTP â†” ROS2)              â”‚
â”‚  â€¢ LIDAR Scanner (360Â° safety)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Exposed Services:**
- `localhost:11345` - Gazebo GUI
- `localhost:8554` - RTSP stream (rtsp://localhost:8554/robotcam)
- `localhost:8080` - Bridge API (HTTP fallback)
- ROS2 Topics: `/cmd_vel`, `/scan`, `/odom`, `/map`, `/plan`

---

#### **2. NAT-Agent Container** (Python 3.11)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     NVIDIA NAT + AI Agent Container         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ LLM Parser (Llama 3.1 70B)               â”‚
â”‚    - Natural language â†’ Mission structure   â”‚
â”‚    - 1x at startup only                     â”‚
â”‚  â€¢ YOLO Object Detection (v11n)             â”‚
â”‚    - 80 COCO classes                        â”‚
â”‚    - 2Hz cached inference                   â”‚
â”‚  â€¢ Mission Controller                       â”‚
â”‚    - State machine for mission tracking     â”‚
â”‚    - Progress monitoring                    â”‚
â”‚  â€¢ Navigation Reasoner                      â”‚
â”‚    - Hybrid Nav2/Manual decision logic      â”‚
â”‚  â€¢ Vision Analyzer                          â”‚
â”‚    - YOLO + LIDAR fusion                    â”‚
â”‚    - Spatial awareness                      â”‚
â”‚  â€¢ ROS2 Client Libraries                    â”‚
â”‚    - rclpy for native ROS2 communication    â”‚
â”‚    - Nav2 action client                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Features:**
- Native ROS2 integration (not bridge-only)
- Direct Nav2 action client for goal sending
- YOLO-only pipeline (BLIP2 removed)
- Mission-driven autonomous behavior

---

### **Workflow tá»•ng quan - Hybrid Docker Architecture**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          HOST SYSTEM                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  User Input: "Run wide automatically in 60 seconds"                     â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                                                  â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  NAT-Agent Container (Python 3.11)                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  1. LLM Parser (1x startup)                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     Input â†’ Mission Structure                               â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  2. Main Control Loop (10Hz)                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”‚ 2a. Vision Analysis (YOLO 2Hz cached)              â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”‚     â€¢ Object detection                             â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”‚     â€¢ LIDAR spatial analysis                       â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”‚ 2b. Mission State Update                           â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”‚     â€¢ Progress tracking                            â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”‚     â€¢ Generate directive                           â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”‚ 2c. Navigation Decision (Hybrid)                   â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”‚     â€¢ Can use Nav2? â†’ Send goal via ROS2 action    â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”‚     â€¢ Need manual? â†’ Generate cmd_vel              â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  ROS2 Client (rclpy) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                       â”‚                 â”‚
â”‚                              ROS2 DDS Network (Domain ID: 42)           â”‚
â”‚                                                       â”‚                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  ROS2-Nav2 Container (Python 3.10)                 â–¼                â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚â”‚
â”‚  â”‚  â”‚  Gazebo Simulation                                          â”‚    â”‚â”‚
â”‚  â”‚  â”‚    â€¢ TurtleBot3 Waffle (camera + lidar)                     â”‚    â”‚â”‚
â”‚  â”‚  â”‚    â€¢ Physics engine                                         â”‚    â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚â”‚
â”‚  â”‚  â”‚  Nav2 Stack                                                 â”‚    â”‚â”‚
â”‚  â”‚  â”‚    â€¢ /navigate_to_pose action server â—„â”€â”€ Receives goals     â”‚    â”‚â”‚
â”‚  â”‚  â”‚    â€¢ Global Planner: A* on costmap                          â”‚    â”‚â”‚
â”‚  â”‚  â”‚    â€¢ Local Planner: DWA real-time obstacles                 â”‚    â”‚â”‚
â”‚  â”‚  â”‚    â€¢ Publishes: /plan, /cmd_vel                             â”‚    â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚â”‚
â”‚  â”‚  â”‚  Sensor Pipeline                                            â”‚    â”‚â”‚
â”‚  â”‚  â”‚    â€¢ Camera â†’ MediaMTX â†’ RTSP stream                        â”‚    â”‚â”‚
â”‚  â”‚  â”‚    â€¢ LIDAR â†’ /scan topic (20Hz)                             â”‚    â”‚â”‚
â”‚  â”‚  â”‚    â€¢ Odometry â†’ /odom topic                                 â”‚    â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚â”‚
â”‚  â”‚  â”‚  Bridge Server (Fallback HTTP API)                          â”‚    â”‚â”‚
â”‚  â”‚  â”‚    â€¢ POST /robot/command â†’ /cmd_vel                         â”‚    â”‚â”‚
â”‚  â”‚  â”‚    â€¢ GET /robot/lidar â†’ LIDAR data                          â”‚    â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                         â”‚
â”‚                          Robot executes safely                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ Kiáº¿n trÃºc

### **1. Docker Multi-Container Architecture**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            HOST SYSTEM (Ubuntu 22.04)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  Docker Daemon                                                             â”‚
â”‚  â”œâ”€ Network: host mode (ROS2 DDS multicast)                                â”‚
â”‚  â”œâ”€ Volume mounts: /tmp/.X11-unix, workspaces, maps                        â”‚
â”‚  â””â”€ ROS_DOMAIN_ID: 42 (isolated from host)                                 â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Container 1: ros2-nav2                                              â”‚  â”‚
â”‚  â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚  â”‚
â”‚  â”‚  Base Image: osrf/ros:humble-desktop-full                            â”‚  â”‚
â”‚  â”‚  Python: 3.10 (ROS2 Humble compatible)                               â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  Installed Packages:                                                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ ros-humble-turtlebot3* (simulation + drivers)                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ ros-humble-navigation2 (Nav2 stack)                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ ros-humble-nav2-bringup (launchers)                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ ros-humble-slam-toolbox (SLAM)                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ ros-humble-gazebo-ros-pkgs (simulation)                          â”‚  â”‚
â”‚  â”‚  â”œâ”€ ros-humble-rmw-cyclonedds-cpp (DDS middleware)                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ flask, requests (bridge server)                                  â”‚  â”‚
â”‚  â”‚  â””â”€ mediamtx (RTSP server binary)                                    â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  Running Services (via ros2_entrypoint.sh):                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Service 1: Gazebo (PID monitoring)                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Launch: turtlebot3_world.launch.py                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Robot model: waffle (camera + lidar + diff_drive)          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ World: turtlebot3_world (obstacles)                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Physics: ODE, 1000Hz                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ GUI: Gazebo client via X11 forwarding                      â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Service 2: Nav2 Stack                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Launch: navigation2.launch.py                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Map: /root/my_map.yaml (pre-built) OR SLAM                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Global Planner: NavFn (Dijkstra/A*)                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Local Planner: DWA (Dynamic Window Approach)               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Costmap:                                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - Static layer (map)                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - Obstacle layer (lidar)                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - Inflation layer (safety buffer)                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Recovery Behaviors:                                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - Rotate recovery                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - Back up recovery                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - Clear costmap recovery                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Action Server: /navigate_to_pose                           â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Service 3: MediaMTX (RTSP Server)                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Binary: /root/mediamtx                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Protocol: RTSP/RTP                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Stream path: /robotcam                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Port: 8554                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Service 4: RTSP Publisher                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Script: rtsp_publisher.py                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Subscribes: /camera/image_raw                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Publishes: rtsp://localhost:8554/robotcam                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Encoding: H.264, 15fps                                     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Service 5: Bridge Server (HTTP â†” ROS2)                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Framework: Flask                                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Port: 8080                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Endpoints:                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - POST /robot/command â†’ /cmd_vel publisher                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - GET /robot/status â†’ health check                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - GET /robot/lidar â†’ /scan subscriber                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Background thread: rclpy.spin_once() loop (100Hz)          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  Exposed Ports:                                                      â”‚  â”‚
â”‚  â”‚  â€¢ 11345: Gazebo master                                              â”‚  â”‚
â”‚  â”‚  â€¢ 8554: RTSP stream                                                 â”‚  â”‚
â”‚  â”‚  â€¢ 8080: Bridge HTTP API                                             â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  Health Check: ros2 topic list (every 5s)                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                            â”‚
â”‚                      ROS2 DDS Network (CycloneDDS)                         â”‚
â”‚                      Domain ID: 42, Multicast enabled                      â”‚
â”‚                                â–²  â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Container 2: nat-agent                                              â”‚  â”‚
â”‚  â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚  â”‚
â”‚  â”‚  Base Image: nvcr.io/nvidia/base/ubuntu:22.04                        â”‚  â”‚
â”‚  â”‚  Python: 3.11 (NAT compatible)                                       â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  Installed Packages:                                                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ nvidia-nat[all]==1.0.0 (AI frameworks)                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ ros-humble-rclpy (ROS2 client - minimal)                         â”‚  â”‚
â”‚  â”‚  â”œâ”€ ros-humble-geometry-msgs, nav-msgs, sensor-msgs                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ ros-humble-nav2-msgs (action definitions)                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ ros-humble-tf-transformations (quaternion utils)                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ ros-humble-rmw-cyclonedds-cpp (DDS middleware)                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ ultralytics (YOLOv11n)                                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ opencv-python, numpy, torch, torchvision                         â”‚  â”‚
â”‚  â”‚  â””â”€ flask, requests (HTTP client)                                    â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  Application Components:                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ 1. LLM Mission Parser (Startup Phase - 1x)                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Model: Llama 3.1 70B via NIM API                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Input: Natural language prompt                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Output: Structured mission object                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     {                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚       "type": "explore_area" | "count_objects" |               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚               "follow_target" | "patrol_laps",                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚       "target_class": "person" | "bottle" | null,              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚       "parameters": {...}                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     }                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Execution time: ~3s                                        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ 2. YOLO Object Detector (Continuous - 2Hz cached)              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Model: YOLOv11n (nano variant)                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Classes: 80 COCO (person, bottle, cup, chair, etc.)        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Input: 640x480 RGB frame from RTSP                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Output: List[Detection]                                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     {                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚       "class": "person",                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚       "confidence": 0.87,                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚       "bbox": [x1, y1, x2, y2],                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚       "center": [cx, cy],                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚       "distance": 1.2  # from LIDAR fusion                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     }                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Inference time: ~50ms (CPU) or ~20ms (GPU)                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Cache duration: 500ms (reduce overhead)                    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ 3. Mission Controller (State Machine)                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Tracks mission progress:                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - count_objects: current_count / target_count              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - follow_target: tracking_state, lost_duration             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - patrol_laps: current_lap / target_laps                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - explore_area: elapsed_time / duration                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Generates directives based on state:                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - explore_random, explore_forward                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - track_follow, track_approach, track_backup               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - track_search_left, track_search_right, track_search_spin â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - patrol_arc_left, patrol_arc_right                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Completion detection: Auto-stop when goal achieved         â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ 4. Vision Analyzer (YOLO + LIDAR Fusion)                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ YOLO detections â†’ 2D bounding boxes                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ LIDAR scan â†’ 360Â° distance map                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Spatial fusion algorithm:                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     1. Project bbox center to angle: Î¸ = atan2(cy, cx)         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     2. Query LIDAR at Î¸ Â± 10Â° cone                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     3. Distance = median(LIDAR readings in cone)               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Outputs:                                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - detected_objects: List[Object with distance]             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - obstacles: [{zone, distance, angle}]                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - clear_paths: ["forward", "left", "right"]                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - safety_score: 0-10                                       â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ 5. Navigation Reasoner (Hybrid Decision Logic)                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Input: mission_directive, vision_analysis, robot_pos       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Decision tree:                                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”‚ Can use Nav2?                                        â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”‚ âœ“ nav2_ready AND robot_pos available AND             â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”‚   directive in {explore_*, patrol_*, track_approach} â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                â”‚ YES                           â”‚ NO            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                â–¼                               â–¼               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”‚ Nav2 Path          â”‚       â”‚ Manual Control           â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”‚ â€¢ Convert directiveâ”‚       â”‚ â€¢ Generate cmd_vel       â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”‚   to (x,y,Î¸) goal  â”‚       â”‚ â€¢ Direct robot control   â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”‚ â€¢ Send via action  â”‚       â”‚ â€¢ LIDAR safety layer     â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â”‚ â€¢ Non-blocking     â”‚       â”‚ â€¢ Blocking with abort    â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Manual directives (Nav2 bypass):                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - track_follow: Real-time YOLO bbox tracking               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - track_backup: Precise reverse distance                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - track_search_spin: 360Â° rotation in place                â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ 6. Robot Controller Interface (ROS2 Native + Bridge)           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Primary mode: Native ROS2 (rclpy)                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - Publisher: /cmd_vel (Twist messages)                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - Subscriber: /scan (LaserScan), /odom (Odometry)          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - Action Client: /navigate_to_pose (Nav2 goals)            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Fallback mode: HTTP Bridge                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - Used if rclpy fails to initialize                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - POST /robot/command, GET /robot/lidar                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Nav2 Integration:                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - nav2_interface.py: NavigateToPose action client          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - send_goal(x, y, theta): Non-blocking goal submission     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - cancel_navigation(): Emergency abort                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - get_state(): Check navigation status                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Safety monitoring:                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - 20Hz LIDAR checks during command execution               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - Immediate abort if obstacle < 0.3m                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - Progressive speed scaling near obstacles                 â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ 7. LIDAR Safety Monitor (Veto Layer)                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Priority 0: Pre-execution check                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - Block command if min_distance < 0.3m                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - Force emergency stop                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Priority 1: Continuous monitoring (20Hz)                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - During command execution                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - Abort mid-execution if critical                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Priority 2: Nav2 safety override                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - Non-blocking check during Nav2 navigation                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - Cancel Nav2 goal if danger detected                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   â€¢ Distance thresholds:                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - CRITICAL: 0.3m (immediate abort)                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - WARNING: 0.5m (speed reduction)                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     - SAFE: 0.8m+ (normal operation)                           â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  Main Control Loop (10Hz - 100ms per iteration):                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ while not mission_completed:                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   1. Get frame from RTSP stream                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   2. Check Nav2 safety (if navigating)           [Priority 0]  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   3. LIDAR safety check (blocking)                [Priority 1] â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   4. Vision analysis (YOLO 2Hz cached)            [Priority 2] â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   5. Mission state update                         [Priority 3] â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   6. Navigation decision (Nav2/Manual)            [Priority 4] â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   7. Execute command (with safety abort)          [Priority 5] â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   8. Sleep 50ms                                                â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  Depends on: ros2-nav2 (waits for healthcheck)                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **2. ROS2 Communication Layer**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ROS2 DDS Network (CycloneDDS)                       â”‚
â”‚                           Domain ID: 42                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Topics (Publish/Subscribe):                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  /cmd_vel (geometry_msgs/Twist)                                   â”‚  â”‚
â”‚  â”‚    Publishers:                                                    â”‚  â”‚
â”‚  â”‚      â€¢ NAT Container (manual control)                             â”‚  â”‚
â”‚  â”‚      â€¢ Nav2 Local Planner (DWA output)                            â”‚  â”‚
â”‚  â”‚    Subscriber: Gazebo diff_drive controller                       â”‚  â”‚
â”‚  â”‚    Rate: Variable (manual: on-demand, Nav2: 20Hz)                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  /scan (sensor_msgs/LaserScan)                                    â”‚  â”‚
â”‚  â”‚    Publisher: Gazebo LiDAR plugin (360Â°, 3.5m max)                â”‚  â”‚
â”‚  â”‚    Subscribers:                                                   â”‚  â”‚
â”‚  â”‚      â€¢ NAT Container (safety monitoring)                          â”‚  â”‚
â”‚  â”‚      â€¢ Nav2 Costmap (obstacle layer)                              â”‚  â”‚
â”‚  â”‚      â€¢ Bridge Server (HTTP endpoint)                              â”‚  â”‚
â”‚  â”‚    Rate: 20Hz                                                     â”‚  â”‚
â”‚  â”‚    Data: 360 range readings, 0.12-3.5m                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  /odom (nav_msgs/Odometry)                                        â”‚  â”‚
â”‚  â”‚    Publisher: Gazebo ground truth odometry                        â”‚  â”‚
â”‚  â”‚    Subscribers:                                                   â”‚  â”‚
â”‚  â”‚      â€¢ NAT Container (robot position)                             â”‚  â”‚
â”‚  â”‚      â€¢ Nav2 (localization)                                        â”‚  â”‚
â”‚  â”‚    Rate: 30Hz                                                     â”‚  â”‚
â”‚  â”‚    Data: position (x,y,Î¸), velocity                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  /camera/image_raw (sensor_msgs/Image)                            â”‚  â”‚
â”‚  â”‚    Publisher: Gazebo camera plugin                                â”‚  â”‚
â”‚  â”‚    Subscriber: RTSP Publisher (MediaMTX bridge)                   â”‚  â”‚
â”‚  â”‚    Rate: 15fps                                                    â”‚  â”‚
â”‚  â”‚    Format: 640x480, RGB8                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  /map (nav_msgs/OccupancyGrid)                                    â”‚  â”‚
â”‚  â”‚    Publisher: Map Server (pre-built) OR SLAM Toolbox              â”‚  â”‚
â”‚  â”‚    Subscriber: Nav2 Global Costmap                                â”‚  â”‚
â”‚  â”‚    Rate: On-demand (static map) or 1Hz (SLAM)                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  /plan (nav_msgs/Path)                                            â”‚  â”‚
â”‚  â”‚    Publisher: Nav2 Global Planner (A*/Dijkstra output)            â”‚  â”‚
â”‚  â”‚    Subscriber: NAT Container (optional visualization)             â”‚  â”‚
â”‚  â”‚    Rate: On new goal or replan (event-driven)                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  Actions (Client/Server):                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  /navigate_to_pose (nav2_msgs/action/NavigateToPose)              â”‚  â”‚
â”‚  â”‚    Server: Nav2 BT Navigator                                      â”‚  â”‚
â”‚  â”‚    Client: NAT Container (nav2_interface.py)                      â”‚  â”‚
â”‚  â”‚    Goal: PoseStamped (x, y, Î¸ in map frame)                       â”‚  â”‚
â”‚  â”‚    Feedback: distance_remaining, ETA                              â”‚  â”‚
â”‚  â”‚    Result: SUCCESS (4) or FAILED (5/6)                            â”‚  â”‚
â”‚  â”‚    Flow:                                                          â”‚  â”‚
â”‚  â”‚      1. NAT sends goal (non-blocking)                             â”‚  â”‚
â”‚  â”‚      2. Nav2 plans global path (A*)                               â”‚  â”‚
â”‚  â”‚      3. Nav2 executes local planner (DWA)                         â”‚  â”‚
â”‚  â”‚      4. Nav2 publishes /cmd_vel continuously                      â”‚  â”‚
â”‚  â”‚      5. Nav2 returns result when goal reached or failed           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **3. Navigation Decision Tree (Hybrid Logic)**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Mission Directive Generated                          â”‚
â”‚             (from mission_controller based on state)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Can use Nav2 for this directive?     â”‚
              â”‚                                      â”‚
              â”‚ Conditions:                          â”‚
              â”‚ âœ“ nav2_ready == True                 â”‚
              â”‚ âœ“ robot_pos available (x, y, Î¸)      â”‚
              â”‚ âœ“ Nav2 not currently navigating      â”‚
              â”‚ âœ“ Directive in Nav2-compatible set:  â”‚
              â”‚   â€¢ explore_*                        â”‚
              â”‚   â€¢ patrol_*                         â”‚
              â”‚   â€¢ track_approach                   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ YES           â”‚ NO
                         â–¼               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      NAV2 PATH             â”‚  â”‚     MANUAL PATH            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           NAV2 PATH                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚ Step 1: Convert directive to (x, y, Î¸) goal                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   current_pos = (robot.x, robot.y, robot.Î¸)                             â”‚
â”‚                                                                         â”‚
â”‚   if directive == "explore_random":                                     â”‚
â”‚     angle = random(-Ï€, Ï€)                                               â”‚
â”‚     distance = random(2.0, 3.0)                                         â”‚
â”‚                                                                         â”‚
â”‚   elif directive == "patrol_arc_left":                                  â”‚
â”‚     angle = robot.Î¸ + 0.3 rad                                           â”‚
â”‚     distance = 1.0                                                      â”‚
â”‚                                                                         â”‚
â”‚   elif directive == "track_approach":                                   â”‚
â”‚     angle = robot.Î¸ + 0.0 rad                                           â”‚
â”‚     distance = 0.5                                                      â”‚
â”‚                                                                         â”‚
â”‚   goal_x = robot.x + distance * cos(angle)                              â”‚
â”‚   goal_y = robot.y + distance * sin(angle)                              â”‚
â”‚   goal_Î¸ = angle                                                        â”‚
â”‚                                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚ Step 2: Send Nav2 goal (non-blocking)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   success = nav2_interface.send_goal(goal_x, goal_y, goal_Î¸)            â”‚
â”‚                                                                         â”‚
â”‚   Action client sends NavigateToPose.Goal to Nav2                       â”‚
â”‚                                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚ Step 3: Nav2 execution flow                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   a. Global Planner (A*/Dijkstra)                                       â”‚
â”‚      â€¢ Searches on costmap                                              â”‚
â”‚      â€¢ Finds optimal path avoiding obstacles                            â”‚
â”‚      â€¢ Publishes to /plan topic                                         â”‚
â”‚                                                                         â”‚
â”‚   b. Local Planner (DWA)                                                â”‚
â”‚      â€¢ Samples velocity trajectories                                    â”‚
â”‚      â€¢ Scores by:                                                       â”‚
â”‚        - Path alignment                                                 â”‚
â”‚        - Obstacle clearance                                             â”‚
â”‚        - Goal distance                                                  â”‚
â”‚      â€¢ Publishes /cmd_vel @ 20Hz                                        â”‚
â”‚                                                                         â”‚
â”‚   c. Recovery Behaviors (if stuck)                                      â”‚
â”‚      â€¢ Rotate 360Â° to find path                                         â”‚
â”‚      â€¢ Back up and retry                                                â”‚
â”‚      â€¢ Clear costmap and replan                                         â”‚
â”‚                                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚ Step 4: NAT Container monitoring                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   â€¢ Continue main loop @ 10Hz                                           â”‚
â”‚   â€¢ Check nav2_interface.is_navigating()                                â”‚
â”‚   â€¢ Safety override if LIDAR critical                                   â”‚
â”‚   â€¢ Cancel Nav2 if mission state changes                                â”‚
â”‚                                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚ Step 5: Completion                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   â€¢ Result callback triggered by action server                          â”‚
â”‚   â€¢ State updates to SUCCEEDED or FAILED                                â”‚
â”‚   â€¢ NAT resumes directive generation                                    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          MANUAL PATH                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚ Step 1: Generate cmd_vel from directive                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   navigation_reasoner.decide_next_action()                              â”‚
â”‚                                                                         â”‚
â”‚   Directive to Command mapping:                                         â”‚
â”‚                                                                         â”‚
â”‚   track_follow:                                                         â”‚
â”‚     â€¢ Use YOLO bbox center (cx, cy)                                     â”‚
â”‚     â€¢ Angular: align with center                                        â”‚
â”‚     â€¢ Linear: approach if distance > 1.5m                               â”‚
â”‚                                                                         â”‚
â”‚   track_backup:                                                         â”‚
â”‚     â€¢ Linear: -0.1 m/s                                                  â”‚
â”‚     â€¢ Duration: calculate from distance                                 â”‚
â”‚                                                                         â”‚
â”‚   track_search_spin:                                                    â”‚
â”‚     â€¢ Angular: 0.5 rad/s                                                â”‚
â”‚     â€¢ Duration: 12s (360Â° rotation)                                     â”‚
â”‚                                                                         â”‚
â”‚   explore_forward:                                                      â”‚
â”‚     â€¢ Linear: 0.15 m/s                                                  â”‚
â”‚     â€¢ Angular: 0.0 (straight)                                           â”‚
â”‚                                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚ Step 2: Pre-execution safety check                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   lidar_data = robot_interface.lidar_data                               â”‚
â”‚   min_dist = min(lidar_data.ranges)                                     â”‚
â”‚                                                                         â”‚
â”‚   if min_dist < 0.3m:                                                   â”‚
â”‚     ABORT â†’ Force stop command                                          â”‚
â”‚     Log: "Pre-execution abort"                                          â”‚
â”‚     return                                                              â”‚
â”‚                                                                         â”‚
â”‚   elif min_dist < 0.5m:                                                 â”‚
â”‚     SCALE DOWN velocity:                                                â”‚
â”‚     scale = (min_dist - 0.3) / 0.2                                      â”‚
â”‚     velocity *= scale * 0.5                                             â”‚
â”‚     Log: "Speed reduction"                                              â”‚
â”‚                                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚ Step 3: Execute command (blocking with abort)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   robot_interface.execute_command(cmd)                                  â”‚
â”‚                                                                         â”‚
â”‚   publish_rate = 20 Hz (50ms interval)                                  â”‚
â”‚   iterations = duration * 20                                            â”‚
â”‚                                                                         â”‚
â”‚   for i in range(iterations):                                           â”‚
â”‚     # CRITICAL: Safety check BEFORE publish                             â”‚
â”‚     fresh_lidar = get_latest_lidar()                                    â”‚
â”‚     min_dist = min(fresh_lidar.ranges)                                  â”‚
â”‚                                                                         â”‚
â”‚     if min_dist < 0.3m:                                                 â”‚
â”‚       # IMMEDIATE ABORT                                                 â”‚
â”‚       publish(Twist.zero()) Ã— 5 times                                   â”‚
â”‚       Log: "Emergency abort mid-execution"                              â”‚
â”‚       return False                                                      â”‚
â”‚                                                                         â”‚
â”‚     elif min_dist < 0.5m:                                               â”‚
â”‚       # PROGRESSIVE SCALING                                             â”‚
â”‚       scale = (min_dist - 0.3) / 0.2                                    â”‚
â”‚       scaled_twist = twist * scale * 0.5                                â”‚
â”‚       publish(scaled_twist)                                             â”‚
â”‚                                                                         â”‚
â”‚     else:                                                               â”‚
â”‚       # SAFE: Publish original command                                  â”‚
â”‚       publish(twist)                                                    â”‚
â”‚                                                                         â”‚
â”‚     sleep(50ms)                                                         â”‚
â”‚                                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚ Step 4: Post-execution                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   â€¢ Return success/failure to main loop                                 â”‚
â”‚   â€¢ Log command result                                                  â”‚
â”‚   â€¢ Continue to next iteration                                          â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚
                             â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Return to main control loop (10Hz)  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **4. Safety Architecture (Multi-Layer Defense)**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SAFETY LAYERS (Priority Order)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Layer 0: Nav2 Costmap (Proactive - 20Hz)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ Input: /map (static) + /scan (dynamic)                         â”‚  â”‚
â”‚  â”‚  â€¢ Inflation radius: 0.5m around obstacles                        â”‚  â”‚
â”‚  â”‚  â€¢ Lethal threshold: Obstacle within robot footprint              â”‚  â”‚
â”‚  â”‚  â€¢ Action: Replan path to avoid inflated areas                    â”‚  â”‚
â”‚  â”‚  â€¢ Response time: <50ms (planner cycle)                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  Layer 1: DWA Local Planner (Reactive - 20Hz)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ Input: Current velocity + LIDAR scan                           â”‚  â”‚
â”‚  â”‚  â€¢ Dynamic Window: Sample forward trajectories                    â”‚  â”‚
â”‚  â”‚  â€¢ Collision check: Project trajectories against obstacles        â”‚  â”‚
â”‚  â”‚  â€¢ Action: Select safe trajectory with best score                 â”‚  â”‚
â”‚  â”‚  â€¢ Fallback: Recovery behaviors if no safe path                   â”‚  â”‚
â”‚  â”‚  â€¢ Response time: 50ms (planner update)                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  Layer 2: NAT LIDAR Veto (Nav2 Override - Non-blocking)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ Check frequency: Every main loop iteration (10Hz)              â”‚  â”‚
â”‚  â”‚  â€¢ Condition: if nav2_interface.is_navigating()                   â”‚  â”‚
â”‚  â”‚  â€¢ Logic:                                                         â”‚  â”‚
â”‚  â”‚    if min(lidar.ranges) < CRITICAL (0.3m):                        â”‚  â”‚
â”‚  â”‚      nav2_interface.cancel_navigation()                           â”‚  â”‚
â”‚  â”‚      Log: "Nav2 aborted - safety override"                        â”‚  â”‚
â”‚  â”‚      Continue loop (non-blocking)                                 â”‚  â”‚
â”‚  â”‚  â€¢ Purpose: Abort Nav2 if it fails to detect danger               â”‚  â”‚
â”‚  â”‚  â€¢ Response time: 100ms (loop period)                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  Layer 3: Pre-Execution Check (Manual Control - Blocking)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ Triggered: Before every manual command                         â”‚  â”‚
â”‚  â”‚  â€¢ Logic:                                                         â”‚  â”‚
â”‚  â”‚    fresh_lidar = get_latest_lidar()                               â”‚  â”‚
â”‚  â”‚    min_dist = min(fresh_lidar.ranges)                             â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚    if min_dist < CRITICAL (0.3m):                                 â”‚  â”‚
â”‚  â”‚      REJECT command                                               â”‚  â”‚
â”‚  â”‚      Force stop: publish Twist.zero()                             â”‚  â”‚
â”‚  â”‚      return to loop                                               â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚    elif min_dist < WARNING (0.5m):                                â”‚  â”‚
â”‚  â”‚      SCALE velocity: v *= (min_dist - 0.3) / 0.2 * 0.5            â”‚  â”‚
â”‚  â”‚      Log: "Speed reduction applied"                               â”‚  â”‚
â”‚  â”‚  â€¢ Purpose: Prevent execution of dangerous commands               â”‚  â”‚
â”‚  â”‚  â€¢ Response time: <10ms (instant)                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  Layer 4: Mid-Execution Abort (Manual Control - Aggressive)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ Check frequency: Every publish cycle (20Hz during motion)      â”‚  â”‚
â”‚  â”‚  â€¢ Logic inside _send_command():                                  â”‚  â”‚
â”‚  â”‚    for each 50ms interval:                                        â”‚  â”‚
â”‚  â”‚      fresh_lidar = get_latest_lidar()                             â”‚  â”‚
â”‚  â”‚      min_dist = min(fresh_lidar.ranges)                           â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚      if min_dist < CRITICAL (0.3m):                               â”‚  â”‚
â”‚  â”‚        # EMERGENCY ABORT                                          â”‚  â”‚
â”‚  â”‚        spam_stop_commands() Ã— 5                                   â”‚  â”‚
â”‚  â”‚        Log: "Emergency abort - obstacle {min_dist}m"              â”‚  â”‚
â”‚  â”‚        return False                                               â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚      elif min_dist < WARNING (0.5m):                              â”‚  â”‚
â”‚  â”‚        # PROGRESSIVE SCALING                                      â”‚  â”‚
â”‚  â”‚        publish(scaled_twist)                                      â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚      else:                                                        â”‚  â”‚
â”‚  â”‚        publish(original_twist)                                    â”‚  â”‚
â”‚  â”‚  â€¢ Purpose: Real-time abort during command execution              â”‚  â”‚
â”‚  â”‚  â€¢ Response time: <50ms (single publish cycle)                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  Layer 5: Exception Handler (Last Resort)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ Triggered: Any unhandled exception in control loop             â”‚  â”‚
â”‚  â”‚  â€¢ Action:                                                        â”‚  â”‚
â”‚  â”‚    try: control_loop()                                            â”‚  â”‚
â”‚  â”‚    except Exception as e:                                         â”‚  â”‚
â”‚  â”‚      Log error                                                    â”‚  â”‚
â”‚  â”‚      spam_stop_commands() Ã— 5                                     â”‚  â”‚
â”‚  â”‚      Set state: ERROR                                             â”‚  â”‚
â”‚  â”‚      Exit gracefully                                              â”‚  â”‚
â”‚  â”‚  â€¢ Purpose: Prevent runaway robot on software crash               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  Distance Thresholds:                                                   â”‚
â”‚  â€¢ CRITICAL: 0.3m - Immediate abort, force stop                         â”‚
â”‚  â€¢ WARNING: 0.5m - Speed reduction, cautious progress                   â”‚
â”‚  â€¢ SAFE: 0.8m+ - Normal operation, full speed allowed                   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ºï¸ Nav2 Integration

### **Lá»£i Ã­ch cá»§a Nav2**

#### **1. Proactive Navigation**
- **TrÆ°á»›c (Reactive LIDAR):** Robot chá»‰ pháº£n á»©ng khi gáº§n váº­t cáº£n
- **Sau (Nav2):** Robot biáº¿t map, plan Ä‘Æ°á»ng trÆ°á»›c, trÃ¡nh chÆ°á»›ng ngáº¡i váº­t sá»›m

#### **2. Global Path Planning**
- Dijkstra/A* algorithm trÃªn map
- TÃ¬m Ä‘Æ°á»ng tá»‘i Æ°u tá»« A â†’ B
- TrÃ¡nh vÃ¹ng nguy hiá»ƒm trÃªn costmap

#### **3. Local Obstacle Avoidance**
- DWA (Dynamic Window Approach)
- Real-time trajectory adjustment
- TrÃ¡nh chÆ°á»›ng ngáº¡i váº­t Ä‘á»™ng

#### **4. Recovery Behaviors**
- Tá»± Ä‘á»™ng thoÃ¡t khi bá»‹ stuck
- Rotate â†’ Clear costmap â†’ Retry
- Backup vÃ  tÃ¬m Ä‘Æ°á»ng khÃ¡c

#### **5. Code Reduction & Reliability**
- Simplified vision pipeline (YOLO + LIDAR only)
- Nav2 handles complex path planning
- Focus on mission-specific behaviors
- Battle-tested navigation algorithms

### **Khi nÃ o dÃ¹ng Nav2 vs Manual**

|      Directive      | Nav2 | Manual |             LÃ½ do            |
|---------------------|------|--------|------------------------------|
| `explore_random`    |  âœ…  |        |       Random goals on map    |
| `patrol_circle`     |  âœ…  |        |  Arc navigation with goals   |
| `track_follow`      |  âš ï¸  |   âœ…   | Target di Ä‘á»™ng, cáº§n reactive |
| `track_backup`      |      |   âœ…   |   Precise distance control   |
| `track_search_spin` |      |   âœ…   |     360Â° rotation in place   |
| `track_approach`    |  âœ…  |        |     Goal-based approach      |

---

## ğŸ® Mission Types

Robot há»— trá»£ 4 loáº¡i nhiá»‡m vá»¥ thÃ´ng qua natural language:

### **1. Count Objects** (Äáº¿m váº­t thá»ƒ)
```bash
"Äáº¿m 10 chai nÆ°á»›c"
"Count 5 cups"
"TÃ¬m 3 ngÆ°á»i"
```
**Navigation:** Nav2 exploration + YOLO detection  
**Behavior:** 
- Explore environment vÃ  Ä‘áº¿m objects
- Dá»«ng khi Ä‘á»§ sá»‘ lÆ°á»£ng
- Track progress: current_count / target_count

**Example Output:**
```
[MISSION] Count 10 bottles
Progress: 3/10 bottles detected
Directive: explore_random (searching for more)
```

---

### **2. Follow Target** (BÃ¡m theo má»¥c tiÃªu)
```bash
"Theo sau ngÆ°á»i Ä‘ang Ä‘i"
"Follow the person"
"Äi theo má»¥c tiÃªu di Ä‘á»™ng"
```
**Navigation:** Hybrid (Nav2 approach + manual tracking)  
**Behavior:** 
- Track target at safe distance (1.0-2.5m)
- YOLO bbox tracking vá»›i real-time adjustment
- Search pattern if lost >3s
- Recovery: rotate, explore, approach

**State Machine:**
```
TRACKING â†’ target visible, distance OK
APPROACHING â†’ target far, move closer
BACKING_UP â†’ target too close (<1.0m)
SEARCHING â†’ target lost, scan environment
```

---

### **3. Patrol Laps** (Tuáº§n tra vÃ²ng)
```bash
"Äi 20 vÃ²ng trÃ²n"
"Patrol 5 laps"
"Tuáº§n tra 10 vÃ²ng"
```
**Navigation:** Nav2 arc goals  
**Behavior:** 
- Complete N circular laps
- Arc-based waypoint generation
- Return to start position after completion
- Track progress: current_lap / target_laps

**Implementation:**
```python
# Generate arc waypoint
angle_offset = 0.3 rad  # 17 degrees
distance = 1.0m
goal = (x + d*cos(Î¸+offset), y + d*sin(Î¸+offset), Î¸+offset)
```

---

### **4. Explore Area** (KhÃ¡m phÃ¡)
```bash
"KhÃ¡m phÃ¡ tá»± do"
"Explore the environment"
"Run wide automatically in 60 seconds"
```
**Navigation:** Nav2 random goals  
**Behavior:** 
- Random waypoint generation on map
- Smooth navigation with obstacle avoidance
- Time-based or continuous exploration
- Coverage maximization

**Parameters:**
- `duration`: Time limit (seconds)
- `coverage`: "full" | "partial" | "random"

---

## ğŸ’» YÃªu cáº§u há»‡ thá»‘ng

### **Pháº§n má»m báº¯t buá»™c**
- **Ubuntu 22.04 LTS** (khuyáº¿n nghá»‹)
- **Docker** 20.10+ with Docker Compose V2
- **NVIDIA GPU** (optional, for faster YOLO)

### **Pháº§n cá»©ng khuyáº¿n nghá»‹**
- **RAM**: 8GB+ (Docker containers: ~3GB)
- **GPU**: NVIDIA with CUDA support (optional)
- **CPU**: 4+ cores
- **Disk**: 20GB free space (Docker images)

### **Dependencies tá»± Ä‘á»™ng cÃ i qua Docker:**
- ROS2 Humble
- Nav2 navigation stack
- TurtleBot3 packages
- YOLO model
- Python libraries

---

## ğŸ”§ CÃ i Ä‘áº·t

### **BÆ°á»›c 1: CÃ i Ä‘áº·t Docker**

```bash
# CÃ i Docker Engine
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Add user to docker group (no sudo needed)
sudo usermod -aG docker $USER
newgrp docker

# Verify installation
docker --version
docker compose version
```

### **BÆ°á»›c 2: Enable X11 forwarding (cho Gazebo GUI)**

```bash
# Install xhost
sudo apt-get update
sudo apt-get install x11-xserver-utils

# Allow Docker to access X server
xhost +local:docker
```

### **BÆ°á»›c 3: Clone Repository**

```bash
cd ~
git clone https://github.com/jerrynguy/final-project.git nemo-agent-toolkit
cd nemo-agent-toolkit
```

### **BÆ°á»›c 4: Táº¡o Map (chá»‰ cáº§n 1 láº§n)**

**Option A: Táº¡o map má»›i vá»›i SLAM**

```bash
# Terminal 1: Launch Gazebo (native ROS2, khÃ´ng dÃ¹ng Docker)
ros2 launch turtlebot3_gazebo turtlebot3_world.launch.py

# Terminal 2: Launch SLAM
ros2 launch slam_toolbox online_async_launch.py use_sim_time:=True

# Terminal 3: Launch RViz
rviz2

# Terminal 4: Teleop Ä‘á»ƒ khÃ¡m phÃ¡ (táº¡o map)
ros2 run turtlebot3_teleop teleop_keyboard

# Terminal 5: Save map khi Ä‘á»§
cd ~
ros2 run nav2_map_server map_saver_cli -f my_map
# Táº¡o ra: my_map.yaml vÃ  my_map.pgm
```

**Option B: DÃ¹ng map cÃ³ sáºµn**

Náº¿u báº¡n Ä‘Ã£ cÃ³ map, Ä‘áº£m báº£o files náº±m á»Ÿ `~/my_map.yaml` vÃ  `~/my_map.pgm`.

### **BÆ°á»›c 5: Build Docker Images**

```bash
cd ~/nemo-agent-toolkit/docker

# Make scripts executable
chmod +x *.sh
chmod +x scripts/*.sh

# Build images (5-10 phÃºt láº§n Ä‘áº§u)
./run.sh
```

Lá»‡nh nÃ y sáº½:
1. Build ROS2-Nav2 container
2. Build NAT-Agent container
3. Start all services
4. Wait for health checks
5. Display status

---

## ğŸš€ CÃ¡ch cháº¡y

### **Quick Start (Recommended)**

```bash
cd ~/nemo-agent-toolkit/docker

# Start entire stack
./run.sh
```

Script tá»± Ä‘á»™ng:
- âœ… Pre-flight checks (Docker, X11, maps)
- âœ… Build images if needed
- âœ… Start containers
- âœ… Wait for services ready
- âœ… Display status and commands

### **Cháº¡y NAT Agent vá»›i Mission**

Sau khi `./run.sh` hoÃ n táº¥t:

```bash
# Enter NAT container
docker exec -it nat_agent_container bash

# Run mission (inside container)
nat run --config_file /workspace/configs/config.yml --input "YOUR_MISSION_HERE"
```

**Example Missions:**

```bash
# Explore vá»›i Nav2
nat run --config_file /workspace/configs/config.yml --input "Run wide automatically in 60 seconds"

# Count objects (YOLO)
nat run --config_file /workspace/configs/config.yml --input "Äáº¿m 10 chai nÆ°á»›c"

# Follow target (Hybrid Nav2 + YOLO)
nat run --config_file /workspace/configs/config.yml --input "Theo sau ngÆ°á»i Ä‘ang Ä‘i"

# Patrol laps (Nav2)
nat run --config_file /workspace/configs/config.yml --input "Äi 5 vÃ²ng trÃ²n"
```

### **Set Initial Pose in RViz (QUAN TRá»ŒNG)**

Nav2 cáº§n biáº¿t vá»‹ trÃ­ ban Ä‘áº§u cá»§a robot:

```bash
# Enter ROS2 container
docker exec -it ros2_nav2_container bash

# Launch RViz
rviz2

# Trong RViz:
# 1. Click "2D Pose Estimate" tool
# 2. Click vÃ o vá»‹ trÃ­ robot trÃªn map
# 3. Drag Ä‘á»ƒ set hÆ°á»›ng
```

### **Monitor System**

```bash
# Check status
./status.sh

# View logs
docker compose logs -f ros2-nav2
docker compose logs -f nat-agent

# Enter containers
docker exec -it ros2_nav2_container bash
docker exec -it nat_agent_container bash

# Check ROS2 topics
docker exec -it ros2_nav2_container bash
ros2 topic list
ros2 topic echo /cmd_vel
ros2 node list
```

### **Stop System**

```bash
# Graceful shutdown
./stop.sh

# Or force stop
docker compose down

# Clean everything (images, volumes)
docker compose down -v --rmi all
```

---

## ğŸ“ Ghi chÃº quan trá»ng

### **Docker Multi-Container Benefits**

âœ… **Isolated Environments:**
- Python 3.11 (NAT) + Python 3.10 (ROS2) no conflict
- Separate dependencies, no version clashes

âœ… **Native ROS2 Communication:**
- Direct DDS network between containers
- No HTTP bridge overhead for ROS2 topics
- Nav2 action client works natively

âœ… **Scalability:**
- Easy to add more containers (vision processing, planning)
- Horizontal scaling possible
- Service-oriented architecture

âœ… **Reproducibility:**
- Identical environment on any machine
- Version-locked dependencies
- Easy deployment to cloud/edge

---

### **Hybrid Navigation Strategy**

**Nav2 Usage (70-80% of time):**
- âœ… `explore_random`: Random waypoints on the map
- âœ… `patrol_*`: Arc-based circular motion
- âœ… `track_approach`: Goal-based target approach
- âœ… Smooth, collision-free paths
- âœ… Auto recovery from stuck situations

**Manual Control (20-30% of time):**
- âœ… `track_follow`: Real-time YOLO bbox tracking
- âœ… `track_backup`: Precise reverse movements
- âœ… `track_search_spin`: 360Â° search rotation
- âœ… Nav2 fallback when goal rejected
- âœ… Emergency behaviors

---

### **Safety Features**

**Multi-Level Protection:**
- ğŸ›¡ï¸ **Level 0 (Nav2 Costmap)**: Proactive path planning around obstacles
- ğŸ›¡ï¸ **Level 1 (DWA Local Planner)**: Real-time trajectory adjustment
- ğŸ›¡ï¸ **Level 2 (LIDAR Veto)**: Pre-execution safety check
- ğŸ›¡ï¸ **Level 3 (20Hz Monitor)**: Continuous safety during movement
- ğŸ›¡ï¸ **Level 4 (Immediate Abort)**: <50ms stop at critical distance
- ğŸ›¡ï¸ **Level 5 (Progressive Scale)**: Speed reduction near obstacles

**Safety Guarantees:**
- âš¡ Response time: <50ms from detection to stop
- ğŸ¯ Abort accuracy: 100% (blocking execution)
- ğŸ“Š Monitoring rate: 20Hz during movement
- ğŸ”’ Override capability: LIDAR Safety > Nav2 > Manual

---

### **AI Pipeline Features**

- **LLM-Powered Parsing**: Natural language â†’ Structured missions (1x startup)
- **YOLO Detection**: 80 COCO classes, 50ms inference, 2Hz cached
- **State Machine**: Mission progress tracking
- **Completion Detection**: Auto-stop when goal achieved
- **Adaptive Navigation**: Hybrid Nav2/Manual based on directive
- **Real-time Tracking**: YOLO bbox center + distance estimation

---

### **Troubleshooting**

**Problem: Gazebo khÃ´ng hiá»ƒn thá»‹ GUI**
```bash
# Check DISPLAY variable
echo $DISPLAY

# Re-enable X11
xhost +local:docker

# Restart containers
./stop.sh && ./run.sh
```

**Problem: Nav2 khÃ´ng nháº­n goal**
```bash
# Check Nav2 status
docker exec -it ros2_nav2_container bash
ros2 node list | grep bt_navigator

# Check if initial pose set
ros2 topic echo /initialpose --once

# Manually set initial pose in RViz
rviz2  # Use "2D Pose Estimate" tool
```

**Problem: RTSP stream khÃ´ng hoáº¡t Ä‘á»™ng**
```bash
# Check MediaMTX
docker exec -it ros2_nav2_container bash
ps aux | grep mediamtx

# Test stream
ffprobe rtsp://localhost:8554/robotcam

# Restart RTSP publisher
docker compose restart ros2-nav2
```

**Problem: Bridge server khÃ´ng response**
```bash
# Check bridge
curl http://localhost:8080/robot/status

# View logs
docker compose logs ros2-nav2 | grep bridge

# Restart service
docker compose restart ros2-nav2
```

**Problem: Container khÃ´ng start**
```bash
# Check Docker logs
docker compose logs

# Check resource usage
docker stats

# Clean and rebuild
docker compose down -v
./run.sh
```

---

### **Limitations**

**Technical Constraints:**
- **YOLO Classes**: Limited to 80 COCO classes
- **Distance Accuracy**: LiDAR-fused (Â±5cm), fallback heuristic when out of LiDAR range (0.12-3.5m)
- **Lap Detection**: Simple odometry-based (no SLAM loop closure)
- **LLM Dependency**: Requires NIM API for prompt parsing
- **Single Robot**: No multi-robot coordination
- **Map Dependency**: Nav2 requires pre-built SLAM map

**Known Issues:**
- Camera resolution fixed at 640x480
- YOLO confidence threshold: 0.5 (adjustable)
- Nav2 goal tolerance: 0.2m position, 0.1rad orientation
- Docker requires ~20GB disk space for images

---

## ğŸ“š References

- [ROS2 Humble Documentation](https://docs.ros.org/en/humble/)
- [Nav2 Documentation](https://navigation.ros.org/)
- [TurtleBot3 Documentation](https://emanual.robotis.com/docs/en/platform/turtlebot3/overview/)
- [Ultralytics YOLO](https://docs.ultralytics.com/)
- [Docker Documentation](https://docs.docker.com/)